<!DOCTYPE html>
<html lang="kr">
<head>
  <meta charset="UTF-8">
  <meta name="description" content="test WebRTC">
  <meta name="viewport" content="width=device-width, user-scalable=yes, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="../commons/css/main.css"/>
</head>
<body>
<div id="container">
  <h1>발표자</h1>
  <video id="localVideo" playsinline autoplay muted></video>
  <canvas></canvas>
  <div>
    <button id="startButton">시작</button>
    <button id="callButton">방 생성</button>
    <button id="hangupButton">방 나가기</button>
  </div>
</div>
<script type="module">
  import { io } from "https://cdn.socket.io/4.4.1/socket.io.esm.min.js";
  const socket = io('http://localhost:3000/create-room');

  const startButton = document.getElementById('startButton');
  const callButton = document.getElementById('callButton');
  const hangupButton = document.getElementById('hangupButton');
  callButton.disabled = true;
  hangupButton.disabled = true;

  const canvas = document.querySelector('canvas');
  const localVideo = document.getElementById('localVideo');

  let localStream = undefined;
  let presenterRTCPC;
  let tmp = []
  const pc_config = {
    iceServers: [
      {
        urls: [
          "stun:stun.l.google.com:19302",
        ]
      },
    ],
  };

  // TODO: 발표자 브라우저에서 미디어 track 설정 & 화면에 영상 출력
  const start = async () => {
    try {
      startButton.disabled = true;
      const stream = await navigator.mediaDevices.getUserMedia({
        audio: true,
        video: true
      });
      localStream = stream;
      localVideo.srcObject = stream;
      callButton.disabled = false;
      console.log('1. 로컬 stream 생성 완료');
      presenterRTCPC = new RTCPeerConnection();
      console.log('2. 로컬 RTCPeerConnection 생성 완료');
      if (localStream) {
        console.log(localStream)
        console.log('track 추가')
        localStream.getTracks().forEach((track) => {
          console.log(track);
          presenterRTCPC.addTrack(track, localStream);
        });
      } else {
        console.log('no stream')
      }
    } catch (e) {
      alert(`getUserMedia() error: ${e.name}`)
    }
  }

  start().then(setStream)

  async function setStream() {
    console.log('setstream 실행')
    try {
      await createPresenterOffer();
      await setServerAnswer();
    } catch (e) {
      console.log(e);
    }
  }

  function getPresenterCandidate() {
    presenterRTCPC.onicecandidate = (e) => {
      if (e.candidate) {
        console.log('발표자 candidate 수집')
        socket.emit('presenterCandidate', {
          candidate: e.candidate,
          presenterSocketId: socket.id
        });
      }
    }
  }

  async function createPresenterOffer() {
    try {
      console.log('offer 생성')
      console.log(presenterRTCPC)
      const SDP = await presenterRTCPC.createOffer();
      console.log(presenterRTCPC)
      socket.emit('presenterOffer', {
        socketId: socket.id,
        SDP: SDP
      });
      console.log('발표자 localDescription 설정 완료');
      presenterRTCPC.setLocalDescription(SDP);
      getPresenterCandidate()
    } catch (e) {
      console.log(e);
    }
  }

  async function setServerAnswer() {
    socket.on(`${socket.id}-serverAnswer`, (data) => {
      console.log('remoteDescription 설정완료')
      presenterRTCPC.setRemoteDescription(data.SDP)
    })
    socket.on(`${socket.id}-serverCandidate`, (data) => {
      console.log('서버로부터 candidate 받음')
      presenterRTCPC.addIceCandidate(new RTCIceCandidate(data.candidate))
    });
  }

  startButton.onclick = start;
</script>
<script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
<script src="../commons/js/streamVisualizer.js"></script>
</body>
</html>
